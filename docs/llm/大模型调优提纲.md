# 大模型微调

## 一 微调的概念

大模型微调（Fine-tuning）是指在预训练的大型语言模型（LLM）基础上，通过针对特定任务或领域的数据进行进一步训练，调整模型参数，以提升其在特定场景下的性能。微调通常在预训练模型（已通过海量通用数据训练，具备广泛知识）的基础上进行，目标是让模型更好地适应特定任务或数据集。

### 微调的作用

1.     领域适应性​  
   大模型能更精准地理解特定领域（如电力）的专业术语、知识结构、表达习惯。  
   
   ​2. 任务准确性​  
   针对特定任务（如逻辑推理、政策解读、案例剖析、指标分解、调节能力评估、异常诊断等），模型输出的结果会更符合任务目标。  
   
   3. ​风格一致性​  
      模型能模仿特定风格（如编写报告），保持输出的一致性。  
   
   4. ​上下文理解​  
      对复杂上下文（如多轮对话、长文本推理）的处理能力更强。  
   
   5. ​输出控制​  
      减少无关或错误信息，生成更安全、合规的内容。

### 

## 二 微调分类

### 1. 全参数微调（Full-Parameter Fine-tuning）

**方案描述**：对模型所有参数进行微调，适用于数据充足、计算资源丰富的场景，能最大化模型性能，但计算和存储成本高。

**适用场景**：

- 需要大幅调整模型行为（如特定领域任务）。
- 有大量标注数据和高性能计算资源。

**优缺点**：

- 优点：性能提升显著，适应性强。
- 缺点：显存需求大，存储整个模型副本。

### 2. 参数高效微调（Parameter-Efficient Fine-tuning, PEFT）

![peft.png](D:\project\errorzhu.github.io\docs\images\wiki\peft.png)

**方案描述**：仅更新少量参数或附加模块，降低计算和存储需求，适合资源受限场景。

**优缺点**：

- 优点：显存需求低，存储成本小，适合大规模模型。
- 缺点：性能可能略逊于全参数微调，需调优超参数。

**子方案**：

## （1） LoRA (Low-Rank Adaptation)

**基本原理**：
LoRA通过添加低秩矩阵来近似权重更新，而不是直接微调所有参数。它对预训练权重矩阵 W 的更新表示为低秩分解：ΔW = A × B，其中A和B是低秩矩阵。

**优点**：

- 参数效率高：仅需训练约0.1%-1%的参数
- 内存占用低：原始预训练权重保持冻结状态
- 模型切换方便：不同任务的LoRA模块可以快速切换
- 训练速度快：显著减少了训练时间和计算资源需求

**缺点**：

- 表现可能略低于全参数微调
- 需要为每层选择合适的秩(rank)
- 不是所有层都同样适合LoRA

**适用场景**：

- 计算资源有限的环境
- 需要快速适应多个下游任务
- 大型语言模型的领域适应

**实施流程**：

1. 冻结预训练模型的全部参数
2. 为需要训练的权重矩阵(通常是注意力层和前馈层)添加LoRA模块
3. 设定低秩参数r(通常为4-64)
4. 仅训练LoRA参数(A和B矩阵)
5. 推理时可以将LoRA权重合并到原始权重或保持独立

## （2）Adapter Tuning (适配器微调)

**基本原理**：
在预训练模型的层与层之间插入小型可训练模块(适配器)，通常包含降维层、非线性激活函数和升维层。原始参数保持冻结。

**优点**：

- 模块化设计：易于添加和移除适配器
- 参数效率高：通常仅增加1-4%的参数
- 可并行化：不同任务的适配器可独立训练
- 适应性强：可以有选择地放置在网络的不同部分

**缺点**：

- 增加了模型的深度和推理延迟
- 架构改变较大：需要修改原始模型架构
- 较LoRA实现复杂：需要适配不同类型的层

**适用场景**：

- 多任务学习环境
- 需要长期维护多个专业化模型变体
- 特别注重模块化和任务隔离的应用

**实施流程**：

1. 冻结预训练模型参数
2. 在关键层后(通常是自注意力层和前馈层后)插入适配器模块
3. 设计适配器架构(通常是降维-激活-升维结构)
4. 仅训练适配器参数
5. 推理时可选择性地启用或禁用适配器

## 案例

 通过LoRA微调提升新型电力负荷系统政策文件解读能力

#### 技术方案简述

本案例采用 **LoRA（Low-Rank Adaptation）** 参数高效微调技术，优化预训练大型语言模型（LLM），以提升其解读 **新型电力负荷系统** 政策文件（如虚拟电厂、需求侧响应相关文件）的能力。微调基于50份标注政策文件数据集（约10万字），包含政策目标、措施和术语解释。

- **数据集**：50份2023-2025年政策文件（如《国家发展改革委办公厅关于进一步加强公共建筑空调负荷管理、统筹促进电力安全保供和节约用电的通知》），标注关键信息、术语和摘要，80%（40份）训练，20%（10份）测试。
- **微调方法**：使用LoRA更新约1%参数（注意力层低秩矩阵），在NVIDIA A100 GPU上训练2小时，学习率1e-4，3个epoch。
- **任务**：
  1. 关键信息提取：提取政策目标和措施。
  2. 术语解释：解释如“需求侧响应”。
  3. 政策总结：生成简洁摘要。

#### 微调前后效果对比

##### 

##### 定性对比

**输入**：

1. 术语解释： 请解释什么是需求响应业务

2. 政策总结： 请用200字总结需求响应政策
- **微调前**：
  
  - **输出**：
    
    - 术语解释：
      
      > 需求响应（Demand Response, DR）是指电力用户根据市场价格信号或激励机制，主动调整用电行为（如减少或转移负荷），以帮助平衡电力供需的一种机制。通常由电网企业或第三方机构组织，通过经济补偿激励用户参与，从而提高电网可靠性和市场效率。
    
    - 政策总结：
    
    - > 需求响应政策是指通过经济激励或价格信号引导电力用户调整用电行为，以平衡电网供需的政策框架。其核心目标是缓解高峰时段负荷压力，提升电网稳定性，并促进可再生能源消纳。政策通常由政府部门主导，电网企业或第三方机构负责实施，用户通过减少或转移用电负荷获得补偿。常见措施包括分时电价、直接负荷控制和市场化竞价。该政策有助于降低发电侧投资成本，减少碳排放，是智能电网建设的重要组成部分。目前，中国、美国、欧盟等均将需求响应纳入电力市场改革重点。

- **问题**：
  
  - 缺乏政策文件中的具体术语。
  
  - 未体现电力政策中的实施细则。
  
  - 回答较笼统，未结合行业案例或政策目标。

- **微调后**：
  
  - **输出**：
    
    - 术语解释：
      
      > 需求响应业务是指根据《电力需求响应管理办法》（202X年）等政策要求，由负荷聚合商、电网企业或电力交易中心组织，通过价格激励或直接控制手段，引导用户在用电高峰时段（如夏季午后）主动削减或转移负荷，实现“削峰填谷”的业务模式。
      > 
      > **核心要素包括**：
      > 
      > 1. **参与主体**：包括工业用户、商业用户、储能设施及负荷聚合商。
      > 
      > 2. **政策工具**：分时电价、尖峰补贴（如XX元/kWh）、可中断负荷协议。
      > 
      > 3. **目标**：提升电网弹性，促进可再生能源消纳（如匹配光伏发电曲线），服务“碳达峰”目标。
      > 
      > **典型案例**：
      > 
      > - 江苏省2023年通过需求响应削减峰值负荷5%，补贴预算2亿元。
      > 
      > - 广东省要求负荷聚合商需具备XXMW以上调节能力方可准入
    
    - 政策总结：
      
      > 根据中国《电力需求响应管理办法（202X年）》，需求响应政策是通过市场化手段（如分时电价、尖峰补贴）和行政调度（如可中断负荷），激励用户主动削减或转移高峰负荷的政策工具。**要点包括**：
      > 
      > 1. **实施主体**：省级电网企业负责组织，负荷聚合商需具备≥XXMW调节能力；
      > 
      > 2. **补偿标准**：削峰响应补贴0.5-2元/kWh（各省浮动），填谷响应侧重可再生能源消纳；
      > 
      > 3. **目标**：2025年前实现峰值负荷削减5%，支撑新型电力系统建设；
      > 
      > 4. **试点案例**：江苏、广东等地将需求响应纳入电力现货市场交易。  
      >    政策明确要求与“碳达峰”目标协同，用户参与情况纳入企业ESG评价。

## 三 微调框架

- https://github.com/hiyouga/LLaMA-Factory

- [PEFT - Hugging Face 机器学习平台](https://hugging-face.cn/docs/peft/index)

- [GitHub - unslothai/unsloth: Finetune Qwen3, Llama 4, TTS, DeepSeek-R1 &amp; Gemma 3 LLMs 2x faster with 70% less memory! 🦥](https://github.com/unslothai/unsloth)

场景1: 获取预警信息  
用户输入: "明天会有负荷缺口吗？需要启动需求响应吗？"  
微调前智能体回复:  
"根据一般情况，明天下午2-5点通常是用电高峰期，尤其是在夏季和冬季。不过我无法确定明天具体情况。'需求响应'可能指的是电力需求管理策略，但我需要更多信息才能给出建议。"  
微调后智能体回复:  
"我将为您查询明天下午的电力负荷预警情况。系统显示明天下午14:00-18:00存在30MW负荷缺口，预计持续4小时，建议启动需求响应。需要我帮您获取详细的预警信息吗？"  

场景2: 分解负荷  
用户输入: "帮我将明天的40MW负荷缺口按平均值法分解到各区域"  
微调前智能体回复:  
"'负荷缺口'和'平均值法'似乎是电力管理相关术语。一般来说，分解工作可以通过平均分配或根据历史数据比例分配。如果您能提供更多关于这些区域的信息，我可以尝试给出建议。"  
微调后智能体回复:  
"正在使用平均值法分解40MW负荷缺口。分解结果如下：  

城南区: 8MW  
城北区: 12MW  
城东区: 10MW  
城西区: 10MW  
是否需要我将这些负荷进一步分解到各供电所级别？"  

场景3: 短信通知下发  
用户输入: "发送需求响应通知给城南区的所有签约用户"  
微调前智能体回复:  
"我理解您需要通知用户。您可以准备一条包含必要信息的短信，比如响应时间、预期减少负荷等。不过您需要使用您组织的短信平台来发送这些通知。需要我帮您起草短信内容吗？"  
微调后智能体回复:  
"正在向城南区128位签约用户发送需求响应短信通知。内容包括：响应时间14:00-18:00，目标削减负荷8MW，补贴标准0.8元/kWh。短信发送完成，预计5分钟内用户将收到通知。是否需要查看短信发送状态？"  

场景4: 统计参与响应的用户数  
用户输入: "统计一下有多少用户回复参与明天的需求响应"  
微调前智能体回复:  
"我无法直接获取用户回复数据。您需要登录您的短信平台或客户管理系统查看回复情况，然后手动统计参与用户数量。"  
微调后智能体回复:  
"正在统计用户回复情况。截至目前，城南区共有84位用户回复参与明天的需求响应，参与率65.6%，预计总响应负荷为6.72MW，未达到目标值8MW。需要我发送追加通知给未回复的用户吗？" 

场景5: 查看用户执行结果  
用户输入: "查看用户603954的响应执行情况"  
微调前智能体回复:  
"我无法直接访问特定用户的数据。您需要登录您的系统，输入用户ID 603954进行查询，或联系技术支持获取该信息。"  
微调后智能体回复:  
"正在查询用户603954的响应执行情况。该用户基准负荷为120kW，响应期间平均负荷为85kW，削减负荷35kW，达成率116.7%，超额完成任务。用户已连续参与3次需求响应，累计获得补贴1240元。需要查看更详细的负荷曲线吗？"  

场景6: 短信监督  
用户输入: "对未达标的用户发送监督短信"  
微调前智能体回复:  
"您可以先确定哪些用户未达标，然后准备一条提醒短信内容。这类监督信息应当礼貌但明确指出未达标情况，并提供改进建议。需要我帮您起草短信内容吗？"  
微调后智能体回复:  
"系统识别出12位未达标用户。正在发送监督短信，内容包括：当前负荷值、目标负荷值、差距百分比及改进建议。短信已发送完成。根据历史数据，发送监督短信后，约60%的用户会调整用电行为。需要查看未达标用户的详细列表吗？"  

场景7: 统计响应执行效果  
用户输入: "生成明天需求响应的执行效果报告"  
微调前智能体回复:  
"要生成执行效果报告，您需要收集以下数据：参与用户数、总响应负荷、达标率等。然后可以使用电子表格或报告工具整理这些信息。如果您能提供这些数据，我可以帮您组织报告结构。"  
微调后智能体回复:  
"正在生成明天需求响应执行效果报告。汇总数据如下：  

目标削减负荷：40MW  
实际削减负荷：36.5MW  
总体达成率：91.3%  
参与用户数：420户  
达标用户数：384户  
用户达标率：91.4%  
高峰时段：14:00-18:00  
最大负荷削减时间点：15:30 (39.2MW)  
报告已生成，是否需要发送给相关负责人？"    
