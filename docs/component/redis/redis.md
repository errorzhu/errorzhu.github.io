# redis

## 关于redis单线程的理解

redis主线程处理接收客户端请求，执行操作，返回结果的步骤，但其他一些工作比如快照备份是在其他线程执行的。

redis使用了io多路复用，在debain系操作系统也就是epoll，可以通过回调的方式处理网络io，这样在单线程中可以非阻塞的处理网络请求，提升了速度



## redis的性能

使用redis-benchmark -t set,get,incr -n 1000000 -q -P 10 -c 100测试，可以达到40w左右的吞吐



## redis的常见用途

高速缓存
分布式锁
消息队列
延迟消息



## 通用的优化方案

设计key

设置缓存过期时间

客户端使用批量命令

使用cluster部署

选择合适的备份方案

# redis性能问题排查

1. 获取 Redis 实例在当前环境下的基线性能。redis intrinsic-latency 120
2. 是否用了慢查询命令？如果是的话，就使用其他命令替代慢查询命令，或者把聚合计算命令放在客户端做。slowlog get
3. 是否对过期 key 设置了相同的过期时间？对于批量删除的 key，可以在每个 key 的过期时间上加一个随机数，避免同时删除。
4. 是否存在 bigkey？ 对于 bigkey 的删除操作，如果你的 Redis 是 4.0 及以上的版本，可以直接利用异步线程机制减少主线程阻塞；如果是 Redis 4.0 以前的版本，可以使用 SCAN 命令迭代删除；对于 bigkey 的集合查询和聚合操作，可以使用 SCAN 命令在客户端完成。
5. Redis AOF 配置级别是什么？业务层面是否的确需要这一可靠性级别？如果我们需要高性能，同时也允许数据丢失，可以将配置项 no-appendfsync-on-rewrite 设置为 yes，避免 AOF 重写和 fsync 竞争磁盘 IO 资源，导致 Redis 延迟增加。当然， 如果既需要高性能又需要高可靠性，最好使用高速固态盘作为 AOF 日志的写入盘。
6. Redis 实例的内存使用是否过大？发生 swap 了吗？如果是的话，就增加机器内存，或者是使用 Redis 集群，分摊单机 Redis 的键值对数量和内存压力。同时，要避免出现 Redis 和其他内存需求大的应用共享机器的情况。
7. 在 Redis 实例的运行环境中，是否启用了透明大页机制？如果是的话，直接关闭内存大页机制就行了。echo never /sys/kernel/mm/transparent_hugepage/enabled
8. 是否运行了 Redis 主从集群？如果是的话，把主库实例的数据量大小控制在 2~4GB，以免主从复制时，从库因加载大的 RDB 文件而阻塞。
9. 是否使用了多核 CPU 或 NUMA 架构的机器运行 Redis 实例？使用多核 CPU 时，可以给 Redis 实例绑定物理核；使用 NUMA 架构时，注意把 Redis 实例和网络中断处理程序运行在同一个 CPU Socket 上。

## sentinel vs cluster

sentinel是监控主节点，主节点挂掉选举从节点，实现了高可用的功能

cluster是对数据分布到多个实例，既实现了高可用，也实现了负载



## 持久化

rdb 全量快照，copy on write机制

aof 预写日志，可做增量

一般用混合方式



## redis业务问题

雪崩------同时缓存失效，打到db,可以设置随机的失效时间，设置二级缓存
穿透------不存在的值打到db，缓存空结果
击穿------热点缓存失效，打到db

#为什么是16384个槽

16384/8=2k,作为心跳数据2k的大小和redis不超过1000个集群的数量对流量的一个平衡

# 内存碎片引起的性能问题
info
mem_fragmentation_ratio [1,1.5]合理，大于1.5考虑碎片问题


# 网络引起的差异
官方说1gb带宽,每次执行会200us的延迟
实测本机执行是远程执行速度的5倍
远程连接redis的话目前机器差不多8w/s的set性能

